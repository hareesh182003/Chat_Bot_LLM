<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chatbot with Login, Password Change & Logout</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; }
    #loginForm, #passwordChangeForm, #chatContainer { 
        width: 90%;             /* Use most of the screen */
        max-width: 1200px;      /* But keep it readable on big screens */
        margin: 20px auto; 
        padding:20px; 
        background:#fff; 
        border-radius:8px; 
        box-shadow:0 2px 6px rgba(0,0,0,0.1); 
        }

    input, button, textarea { padding:10px; margin:5px 0; width:100%; border-radius:5px; border:1px solid #ccc; }
    button { cursor:pointer; background:#007bff; color:#fff; border:none; }
    button:hover { background:#0056b3; }
    #messages {
        max-height: 70vh;       /* Take 70% of screen height */
        overflow-y:auto; 
        margin-bottom:10px;
        }
    .msg { margin:10px 0; clear:both; }
    .bubble { display:inline-block; padding:10px; border-radius:8px; max-width:80%; }
    .me .bubble { background:#007bff; color:white; float:right; }
    .msg:not(.me) .bubble { background:#eee; }
    .meta { font-size:0.7em; opacity:0.7; margin-bottom:3px; }
    .typing { display:flex; gap:4px; }
    .dot { width:6px; height:6px; border-radius:50%; background:#333; animation: blink 1s infinite; }
    .dot:nth-child(2){animation-delay:0.2s;}
    .dot:nth-child(3){animation-delay:0.4s;}
    @keyframes blink { 0%,80%,100% {opacity:0.2;} 40% {opacity:1;} }
    #logoutBtn { background:#dc3545; } 
    #logoutBtn:hover { background:#a71d2a; }
  </style>
</head>
<body>

  <!-- Login Form -->
  <div id="loginForm">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Password Change Form -->
  <div id="passwordChangeForm" style="display:none;">
    <h2>Change Default Password</h2>
    <input type="password" id="newPassword" placeholder="New Password">
    <button id="changePwdBtn">Update Password</button>
    <div id="pwdMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- Chatbot -->
  <div id="chatContainer" style="display:none;">
    <h2>Chatbot</h2>
    <div id="messages"></div>
    <textarea id="input" rows="2" placeholder="Type your message..."></textarea>
    <button id="sendBtn">Send</button>
    <button id="clearBtn">Clear</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // ---------- CHAT UI HELPERS ----------
    function appendMessage(text, who='bot'){
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (who==='me' ? 'me' : '');
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = who === 'me' ? 'You' : 'Bot';
        bubble.appendChild(meta);

        let content;
        try {
            // Try to parse JSON
            const obj = JSON.parse(text);
            content = formatJSON(obj);
        } catch {
            // Normal text
            content = document.createElement('div');
            content.innerHTML = escapeHtml(text).replace(/\n/g,'<br>');
        }

        bubble.appendChild(content);
        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        }


    function formatJSON(obj) {
        if (typeof obj !== 'object' || obj === null) {
            const span = document.createElement('span');
            span.textContent = obj;
            return span;
        }

        const table = document.createElement('table');
        table.style.borderCollapse = 'collapse';
        table.style.margin = '5px 0';
        table.style.width = '100%';

        for (const key in obj) {
            const row = document.createElement('tr');

            const keyCell = document.createElement('td');
            keyCell.textContent = key;
            keyCell.style.fontWeight = 'bold';
            keyCell.style.padding = '4px 6px';
            keyCell.style.border = '1px solid #ddd';
            keyCell.style.width = '30%';

            const valCell = document.createElement('td');
            valCell.style.padding = '4px 6px';
            valCell.style.border = '1px solid #ddd';

            if (typeof obj[key] === 'object') {
            valCell.appendChild(formatJSON(obj[key]));
            } else {
            valCell.textContent = obj[key];
            }

            row.appendChild(keyCell);
            row.appendChild(valCell);
            table.appendChild(row);
        }
        return table;
        }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showTyping(){
      const t = document.createElement('div');
      t.className = 'msg'; t.id = 'typing';
      const b = document.createElement('div'); b.className = 'bubble';
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent='Bot'; b.appendChild(meta);
      const typing = document.createElement('div'); typing.className='typing';
      for(let i=0;i<3;i++){const d=document.createElement('div');d.className='dot';typing.appendChild(d)}
      b.appendChild(typing); t.appendChild(b);
      messagesEl.appendChild(t); messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function hideTyping(){const t=document.getElementById('typing'); if(t) t.remove();}

    // ---------- CALL BOT ----------
    async function botResponse(prompt) {
      async function callLLMAction(token) {
        return fetch("http://127.0.0.1:8000/api/llm-action/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { "Authorization": "Bearer " + token } : {}),
          },
          body: JSON.stringify({ prompt }),
        });
      }

      try {
        let access = localStorage.getItem("access_token");
        let res = await callLLMAction(access);

        if (res.status === 401 || res.status === 403) {
          const refresh = localStorage.getItem("refresh_token");
          if (!refresh) return "⚠️ Session expired. Please login again.";

          const refreshRes = await fetch("http://127.0.0.1:8000/api/token/refresh/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh }),
          });

          if (!refreshRes.ok) {
            logout(); return "⚠️ Refresh failed. Please login again.";
          }

          const refreshData = await refreshRes.json();
          access = refreshData.access;
          localStorage.setItem("access_token", access);
          res = await callLLMAction(access);
        }

        if (!res.ok) throw new Error("Server error: " + res.status);
        const data = await res.json();
        return typeof data === "object" ? JSON.stringify(data, null, 2) : String(data);
      } catch (err) {
        return "❌ " + err.message;
      }
    }

    async function sendMessage(){
      const text = inputEl.value.trim();
      if(!text) return;
      appendMessage(text,'me');
      inputEl.value = '';
      showTyping();
      try{
        const botReply = await botResponse(text);
        hideTyping();
        appendMessage(botReply,'bot');
      }catch(err){
        hideTyping();
        appendMessage('Error: '+String(err),'bot');
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    clearBtn.addEventListener('click', ()=>{messagesEl.innerHTML='';});
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    // ---------- LOGIN ----------
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const loginMsg = document.getElementById("loginMsg");

      try {
        const res = await fetch("http://127.0.0.1:8000/api/token/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        if (!res.ok) {
          loginMsg.textContent = "❌ Login failed. Check credentials.";
          return;
        }

        const data = await res.json();
        localStorage.setItem("access_token", data.access);
        localStorage.setItem("refresh_token", data.refresh);

        if (data.must_change_password) {
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("passwordChangeForm").style.display = "block";
        } else {
          loginMsg.style.color = "green";
          loginMsg.textContent = "✅ Login successful!";
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("chatContainer").style.display = "block";
          appendMessage("Welcome! You are now logged in. Type a message to start chatting.");
        }
      } catch (err) {
        loginMsg.textContent = "❌ Error: " + err.message;
      }
    });

    // ---------- PASSWORD CHANGE ----------
    document.getElementById("changePwdBtn").addEventListener("click", async () => {
      const newPassword = document.getElementById("newPassword").value;
      const pwdMsg = document.getElementById("pwdMsg");
      const token = localStorage.getItem("access_token");

      try {
        const res = await fetch("http://127.0.0.1:8000/api/me/", {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token,
          },
          body: JSON.stringify({ password: newPassword }),
        });

        if (!res.ok) {
          pwdMsg.textContent = "❌ Password change failed.";
          return;
        }

        pwdMsg.style.color = "green";
        pwdMsg.textContent = "✅ Password updated successfully! Please login again.";
        setTimeout(() => { logout(); }, 2000);
      } catch (err) {
        pwdMsg.textContent = "❌ Error: " + err.message;
      }
    });

    // ---------- LOGOUT ----------
    logoutBtn.addEventListener("click", logout);
    function logout(){
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      messagesEl.innerHTML = "";
      document.getElementById("chatContainer").style.display = "none";
      document.getElementById("passwordChangeForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("loginMsg").textContent = "ℹ️ You have been logged out.";
    }
  </script>
</body>
</html>
